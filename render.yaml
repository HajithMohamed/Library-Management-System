# render.yaml
# Defines the services for your application on Render.

services:
  #-----------------------------------
  # PHP Backend Service (as a public Web Service)
  #-----------------------------------
  - type: web
    name: ils-php
    env: docker
    plan: free
    dockerfilePath: ./docker/php/Dockerfile
    dockerContext: .
    startCommand: /usr/local/bin/render-start.sh
    # 'ports' field is not used for Docker services; port is auto-detected.
    envVars:
      - key: TZ
        value: Asia/Kolkata
      - fromGroup: ils-database-credentials
      - key: ADMIN_CODE
        sync: false
      - key: SMTP_HOST
        value: smtp.gmail.com
      - key: SMTP_PORT
        value: 587
      - key: SMTP_USERNAME
        sync: false
      - key: SMTP_PASSWORD
        sync: false
      - key: SMTP_ENCRYPTION
        value: tls
      - key: SMTP_FROM_EMAIL
        sync: false
      - key: SMTP_FROM_NAME
        value: "Library System"
      - key: SMS_API_URL
        value: ""
      - key: SMS_API_KEY
        sync: false
      - key: SMS_SENDER_ID
        value: ""

  #-----------------------------------
  # Nginx Web Server (Public)
  #-----------------------------------
  - type: web
    name: ils-nginx
    env: docker
    dockerfilePath: ./docker/nginx/Dockerfile.render
    dockerContext: .
    plan: free
    # Corrected: Removed the 'ports' field. It's not valid for Docker services.
    # Render will auto-detect port 80 exposed in the Nginx Dockerfile.
    envVars:
      - key: PHP_HOST
        fromService:
          type: web
          name: ils-php
          property: host
      - key: PHP_PORT
        fromService:
          type: web
          name: ils-php
          property: port

  #-----------------------------------
  # phpMyAdmin Service (Optional, Public)
  #-----------------------------------
  - type: web
    name: ils-phpmyadmin
    env: docker
    # Corrected: The field is 'image', not 'dockerImage'.
    image: phpmyadmin/phpmyadmin:latest
    plan: free
    envVars:
      - key: PMA_HOST
        fromService:
          type: mysql
          name: ils-db
          property: host
      - key: PMA_USER
        fromService:
          type: mysql
          name: ils-db
          property: user
      - key: PMA_PASSWORD
        fromService:
          type: mysql
          name: ils-db
          property: password

#-----------------------------------
# Managed Database
#-----------------------------------
databases:
  - name: ils-db
    databaseName: integrated_library_system
    user: library_user
    plan: free
    # Corrected: The field is 'engine', not 'type'.
    engine: mysql

#-----------------------------------
# Environment Variable Group
#-----------------------------------
envVarGroups:
  - name: ils-database-credentials
    envVars:
      - key: DB_HOST
        fromService:
          type: mysql
          name: ils-db
          property: host
      - key: DB_PORT
        fromService:
          type: mysql
          name: ils-db
          property: port
      - key: DB_USER
        fromService:
          type: mysql
          name: ils-db
          property: user
      - key: DB_PASSWORD
        fromService:
          type: mysql
          name: ils-db
          property: password
      - key: DB_NAME
        fromService:
          type: mysql
          name: ils-db
          property: database
